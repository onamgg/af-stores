<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AF Stores</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
  text-align: center;
  background: linear-gradient(rgba(255,255,255,0.5), rgba(255,255,255,0.5)),
              url('https://i.ytimg.com/vi/UsV5lQ9kVJY/hq720.jpg?sqp=-oaymwEhCK4FEIIDSFryq4qpAxMIARUAAAAAGAElAADIQj0AgKJD&rs=AOn4CLDvcVX_rapybwEyLrWEb8HLrwi-qg.jpg');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  transition: 0.4s;
}

h1 {
  background: #222;
  color: white;
  padding: 15px;
  margin: 0;
  animation: slideDown 0.6s ease-out;
}

@keyframes slideDown {
  0% { transform: translateY(-50px); opacity: 0; }
  100% { transform: translateY(0); opacity: 1; }
}

#store-info {
  margin: 15px auto;
  max-width: 700px;
  font-size: 18px;
  color: #333;
  animation: fadeIn 1s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

#categories button {
  padding: 10px 20px;
  margin: 10px;
  font-size: 16px;
  cursor: pointer;
  transition: 0.3s;
}
#categories button:hover { transform: scale(1.1); }

#products {
  display: none;
  margin-top: 20px;
  flex-wrap: wrap;
  justify-content: center;
}

.product {
  border: 1px solid #ccc;
  margin: 15px;
  padding: 10px;
  width: 220px;
  background: rgba(255,255,255,0.95);
  border-radius: 8px;
  display: inline-block;
  transition: 0.3s;
}
.product:hover { transform: translateY(-5px); box-shadow: 0 8px 12px rgba(0,0,0,0.2); }

.product img {
  width: 100%;
  height: 130px;
  object-fit: cover;
  border-radius: 5px;
}

#cartButton {
  position: fixed;
  top: 15px;
  right: 15px;
  background: green;
  color: white;
  padding: 10px 15px;
  cursor: pointer;
  border-radius: 5px;
  z-index: 1000;
}

#cart {
  position: fixed;
  right: -320px;
  top: 0;
  width: 300px;
  height: 100%;
  background: #f4f4f4;
  border-left: 2px solid #ccc;
  padding: 10px;
  overflow-y: auto;
  transition: 0.3s;
}
#cart.show { right: 0; }

#cart li button {
  margin-left: 10px;
  background: crimson;
  color: white;
  border: none;
  padding: 3px 6px;
  border-radius: 4px;
  cursor: pointer;
}

.checkout-btn {
  background: green;
  color: white;
  padding: 10px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  margin-top: 10px;
}
</style>
</head>

<body>

<h1>AF Stores</h1>

<div id="store-info">
  Welcome to AF Stores! We sell fresh vegetables by weight, bakery items, and stationary. Prices are updated live and stock reduces only when you checkout.
</div>

<div id="cartButton" onclick="toggleCart()">ðŸ›’ Cart</div>

<div id="categories">
  <button onclick="showCategory('vegetable')">Vegetables</button>
  <button onclick="showCategory('stationary')">Stationary</button>
  <button onclick="showCategory('bakery')">Bakery</button>
</div>

<div id="products"></div>

<div id="cart">
  <h2>Your Cart</h2>
  <ul id="cartList"></ul>
  <p id="total">Total: â‚¹0</p>
  <button onclick="checkout()" class="checkout-btn">Checkout</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc, addDoc } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDUeKvzHtL3wfad44uYZy4BauoBKLl75Xc",
  authDomain: "af-stores.firebaseapp.com",
  projectId: "af-stores",
  storageBucket: "af-stores.firebasestorage.app",
  messagingSenderId: "812053057314",
  appId: "1:812053057314:web:6eac81748c9dae4018df7b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let cart = [];
let currentProducts = [];
let customer = { name: '', phone: '' };

// Show category
window.showCategory = async function(category){
  const productsDiv = document.getElementById("products");
  productsDiv.innerHTML = "";
  productsDiv.style.display = "flex";

  const querySnapshot = await getDocs(collection(db, "products"));
  currentProducts = [];

  querySnapshot.forEach(docSnap => {
    const data = docSnap.data();
    if(data.category === category){
      currentProducts.push({ id: docSnap.id, ...data, quantity: 0 });
    }
  });

  currentProducts.forEach((item, index) => {
    let qtyInput = '';
    if(item.category === 'vegetable'){
      qtyInput = `<input type="number" min="0" max="${item.stock}" step="0.1" placeholder="kg" 
      id="veg-${index}" style="width:60px;">`;
    }
    productsDiv.innerHTML += `
      <div class="product">
        <img src="${item.image}">
        <h3>${item.name}</h3>
        <p>Price: â‚¹${item.price} per ${item.category==='vegetable'?'kg':'item'}</p>
        <p>Stock: ${item.stock}${item.category==='vegetable'?' kg':''}</p>
        ${qtyInput}
        <button onclick="addToCart(${index})">Add to Cart</button>
      </div>`;
  });
};

// Add to cart (does NOT reduce stock yet)
window.addToCart = function(index){
  const item = currentProducts[index];
  let quantity = 1;
  if(item.category === 'vegetable'){
    const val = parseFloat(document.getElementById(`veg-${index}`).value);
    if(isNaN(val) || val <= 0){
      alert("Enter a valid weight in kg!");
      return;
    }
    quantity = val;
    if(quantity > item.stock){
      alert("Not enough stock!");
      return;
    }
  } else {
    if(item.stock <= 0){
      alert("Out of Stock!");
      return;
    }
  }

  const existing = cart.find(c => c.id === item.id);
  if(existing){
    existing.quantity += quantity;
  } else {
    cart.push({ ...item, quantity });
  }

  updateCart();
};

function updateCart(){
  const cartList = document.getElementById("cartList");
  const total = document.getElementById("total");
  cartList.innerHTML = "";
  let sum = 0;

  cart.forEach(item => {
    const itemTotal = item.category === 'vegetable' ? item.price * item.quantity : item.price * item.quantity;
    sum += itemTotal;
    cartList.innerHTML += `<li>${item.name} - ${item.quantity} ${item.category==='vegetable'?'kg':'pcs'} - â‚¹${itemTotal}</li>`;
  });

  total.innerText = "Total: â‚¹" + sum;
}

window.toggleCart = function(){
  document.getElementById("cart").classList.toggle("show");
};

// Checkout (reduces stock and saves order)
window.checkout = async function(){
  if(cart.length === 0){
    alert("Your cart is empty!");
    return;
  }

  // Prompt for customer info if missing
  if(!customer.name) customer.name = prompt("Enter your Name (mandatory):");
  if(!customer.phone) customer.phone = prompt("Enter your Phone Number (mandatory):");

  if(!customer.name || !customer.phone){
    alert("Name and phone number are required to checkout!");
    return;
  }

  // Reduce stock in Firebase
  for(const item of cart){
    const productRef = doc(db, "products", item.id);
    let newStock = item.stock - item.quantity;
    if(newStock < 0) newStock = 0;
    await updateDoc(productRef, { stock: newStock });
  }

  // Save order
  await addDoc(collection(db, "orders"), {
    name: customer.name,
    phone: customer.phone,
    items: cart.map(i => ({ name: i.name, category: i.category, quantity: i.quantity, price: i.price })),
    total: cart.reduce((a,b)=>a + b.price*(b.category==='vegetable'?b.quantity: b.quantity),0),
    timestamp: new Date().toISOString()
  });

  cart = [];
  updateCart();
  alert("Order placed successfully!");
  window.location.href = "thankyou.html";
};
</script>
</body>
</html>
